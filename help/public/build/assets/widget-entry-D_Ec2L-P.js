const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./livechat-popup-DMZoKDEL.js","./client-DtfdVV77.js","./agent-avatar-zWPNofnN.js","./use-compact-agents-BbfR0BTv.js","./helpdesk-channel-CQKSbeKg.js","./online-status-circle-Nb704kAK.js","./HourglassEmpty-T3VQEBmq.js","./reverse-conversation-messages-D589XwPM.js","./infinite-scroll-sentinel-Dx_uGmDU.js","./isScrollable-BSEN4xi5.js","./customer-avatar-ul3Z1Bt5.js","./feed-attachments-Dbj_-UUy.js","./animating-messages-DuT2CR0j.js","./file-thumbnail-DlIWt16b.js","./file-type-icon-CNIGAaMG.js","./formatted-bytes-CFeeP1Iy.js","./pretty-bytes-bO14ePu9.js","./AttachFile-D1Gtc63k.js","./ticket-details-CyooeAxc.js","./attribute-renderer-C6KvryoI.js","./ThumbDown-BB-li-Gi.js","./ThumbUp-CTCneb2T.js","./conversation-priority-CeA32zhn.js","./file-upload-provider-B4w-VsYu.js","./uploaded-file-DOXWsty7.js","./with-selector-DPNnjGhI.js","./Edit-BaEHOLuK.js","./Email-DbuUu46B.js","./ConfirmationNumber-CY9CjtLz.js","./Download-44KjkU3h.js","./MoreHoriz-Df3_bV9s.js","./Schedule-BAyUsflh.js","./FullscreenExit-DqIV63hh.js","./confirmation-dialog-BzXs9ksK.js","./download-file-from-url-hJ3EUwXO.js","./message-author-name-Bk8LQSvQ.js","./unseen-messages-badge-CODRuz4h.js","./websocket-updates-notifier-3Xk6dITh.js","./bullet-seprated-items-ClWbAIQG.js","./useInfiniteQuery-CRfa2XSO.js","./infiniteQueryObserver-JD1WF4OJ.js","./messages-square-icon-D_3IR-rK.js","./Send-BbKd9OAw.js","./custom-menu-Dvq-fOnC.js","./ArrowBack-DIhVch2U.js","./skeleton-D178v0-U.js","./search-D3bB1V5N.js","./article-link-kVBPNf7I.js","./slugify-string-CGmMIJK7.js","./article-page-feedback-BwJoJxrd.js","./use-required-params-BhaT_-q3.js","./OpenInNew-C06CZDpe.js","./css-props-from-bg-config-CgypBlFP.js","./avatar-group-BIYHgzHR.js","./attribute-input-renderer-BEkqCl5D.js","./button-group-DAgYjIi8.js","./date-picker-BGiTN72q.js","./radio-DP8xYP6t.js","./radio-group-C_T7jNq6.js","./select-D9niWe2H.js","./combobox-end-adornment-CWQ4Xgal.js","./checkbox-CS7ILu6P.js","./CheckBoxOutlineBlank-DU0ZdwTb.js","./use-customer-new-ticket-form-BHe-zvou.js","./useSuspenseQuery-Bmt2-NKx.js","./accordtion-animation-BGCK95Hj.js","./get-default-values-for-form-with-attributes-htMbgWW2.js","./use-upload-attachments-CRLnN22_.js","./use-captcha-BCeBTZMW.js","./paperclip-1tb_aUIl.js","./progress-bar-BMzArYUQ.js","./open-upload-window-DE9Q8gNs.js","./widget-navigation-CQEGuGCg.js","./Chat-C94dcr0C.js","./Help-DMvOY11L.js","./HelpOutline-DkAeNvPf.js","./Home-iO0iebLw.js","./preview-messages-B_u8VttT.js","./stream-BOYAfkJs.js","./useMutationState-Bmyxea6H.js","./formatted-message-body-N3ejX0-V.js","./emoji-picker-button-Cm_kBrZ5.js","./tiptap-editor-context-CeN7pXcf.js","./check-circle-filled-B4oRGH_i.js","./Add-B1HfWgJf.js","./play-conversation-sound-OdSdmIQ4.js","./ChatBubbleOutline-D_zVnkWb.js","./index.module-BtHqevI0.js","./widget-active-campaign-CQIQFSjD.js","./campaign-renderer-D82hYDpC.js"])))=>i.map(i=>d[i]);
var pt=Object.defineProperty;var gt=(e,t,s)=>t in e?pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var xe=(e,t,s)=>gt(e,typeof t!="symbol"?t+"":t,s);import{af as C,bz as ft,cO as we,cq as q,cr as T,cP as be,q as f,i as B,s as E,k as ue,X as Ue,l as ht,r as d,j as n,c0 as vt,B as de,aP as yt,d as xt,T as j,bg as oe,aU as O,aT as Le,bd as me,cQ as wt,cu as bt,w as Ct,h as X,c as Ke,b3 as qe,t as Ce,m as le,aJ as jt,aK as St,p as _,D as At,bx as U,u as F,a as Oe,am as It,an as Mt,ae as Tt,P as Re,ap as Pt,aj as L,aR as ze,as as Qe,a_ as pe,E as _t,cf as Nt,cg as Et,bZ as Ft,av as Dt,bh as kt,b4 as Wt,ac as Bt,cR as H,cG as Ut,cH as je,cE as Lt,cF as Kt,b2 as P,A as ce,z as Se,bL as Ae,bc as $e,x as Ie,bG as qt,cS as Ot,cT as Rt,bI as zt,cU as Qt,cV as $t,cW as Vt,cX as Ht,cY as Gt,cZ as Xt,c_ as Jt}from"./client-DtfdVV77.js";import{e as Zt,s as Yt}from"./online-status-circle-Nb704kAK.js";import{a as G}from"./preview-messages-B_u8VttT.js";import{A as D,F as Ve,a as He,b as es,c as ts,i as Ge}from"./feed-attachments-Dbj_-UUy.js";import{a as ss,b as Me,u as ns,r as as,M as is}from"./reverse-conversation-messages-D589XwPM.js";import{u as w,r as Xe,F as rs}from"./file-upload-provider-B4w-VsYu.js";import{A as os}from"./attribute-renderer-C6KvryoI.js";import{A as ls}from"./attribute-input-renderer-BEkqCl5D.js";import{g as cs}from"./get-default-values-for-form-with-attributes-htMbgWW2.js";import{H as Je}from"./HelpOutline-DkAeNvPf.js";import{E as us,m as J}from"./stream-BOYAfkJs.js";import{a as K}from"./animating-messages-DuT2CR0j.js";import{u as ds}from"./useMutationState-Bmyxea6H.js";import{F as ms}from"./formatted-message-body-N3ejX0-V.js";import{u as ps}from"./useInfiniteQuery-CRfa2XSO.js";import{E as gs}from"./emoji-picker-button-Cm_kBrZ5.js";import{F as fs,a as hs}from"./file-thumbnail-DlIWt16b.js";import{C as vs}from"./check-circle-filled-B4oRGH_i.js";import{A as ys}from"./Add-B1HfWgJf.js";import{o as Ze}from"./open-upload-window-DE9Q8gNs.js";import{A as xs}from"./AttachFile-D1Gtc63k.js";import{S as ws}from"./Send-BbKd9OAw.js";import{p as bs}from"./play-conversation-sound-OdSdmIQ4.js";import{W as Cs,u as Ye}from"./websocket-updates-notifier-3Xk6dITh.js";import{C as js}from"./ChatBubbleOutline-D_zVnkWb.js";import{h as M}from"./helpdesk-channel-CQKSbeKg.js";import{c as Ss}from"./index.module-BtHqevI0.js";import"./HourglassEmpty-T3VQEBmq.js";import"./formatted-bytes-CFeeP1Iy.js";import"./pretty-bytes-bO14ePu9.js";import"./infinite-scroll-sentinel-Dx_uGmDU.js";import"./isScrollable-BSEN4xi5.js";import"./agent-avatar-zWPNofnN.js";import"./use-compact-agents-BbfR0BTv.js";import"./customer-avatar-ul3Z1Bt5.js";import"./uploaded-file-DOXWsty7.js";import"./with-selector-DPNnjGhI.js";import"./ThumbDown-BB-li-Gi.js";import"./ThumbUp-CTCneb2T.js";import"./button-group-DAgYjIi8.js";import"./date-picker-BGiTN72q.js";import"./radio-DP8xYP6t.js";import"./radio-group-C_T7jNq6.js";import"./select-D9niWe2H.js";import"./combobox-end-adornment-CWQ4Xgal.js";import"./checkbox-CS7ILu6P.js";import"./CheckBoxOutlineBlank-DU0ZdwTb.js";import"./infiniteQueryObserver-JD1WF4OJ.js";import"./tiptap-editor-context-CeN7pXcf.js";import"./file-type-icon-CNIGAaMG.js";function et(){const{data:e}=ft();return e}function N(){return C()}const v={customers:{invalidateKey:["users","customers"],get:()=>q({queryKey:["users","customers","widget"],queryFn:()=>T("lc/widget/customer")})},conversations:{invalidateKey:["conversations"],index:()=>we({queryKey:["conversations","widget"],queryFn:({pageParam:e})=>T("lc/widget/conversations",e?{cursor:e}:void 0),initialPageParam:null,getNextPageParam:be}),get:e=>q({enabled:!!e,queryKey:["conversations","widget",`${e}`],queryFn:async()=>{const t=await T(`lc/widget/conversations/${e}`);return st(t),t}}),messages:e=>we({staleTime:1/0,queryKey:["conversations","widget",`${e}`,"messages"],queryFn:({pageParam:t})=>T(`lc/widget/chats/${e}/messages`,t?{cursor:t}:void 0),initialPageParam:null,getNextPageParam:be})},articles:{hcData:()=>{const e=N().scopedHcCategoryId,t=e?{categoryId:e}:void 0;return q({queryKey:["articles","widget","hcData"],queryFn:()=>T("lc/widget/help-center-data",t)})},homeArticleList:()=>{const e=N().scopedHcCategoryId,t=e?{categoryId:e}:void 0;return q({queryKey:["articles","widget","homeArticleList"],queryFn:()=>T("lc/widget/home-article-list",t)})}}};function tt(e,t){f.setQueryData(v.conversations.get(e).queryKey,t),st(t)}function st(e){f.setQueryData(v.conversations.messages(e.conversation.id).queryKey,t=>t?(t.pages[0]={pagination:e.items},{pages:t.pages,pageParams:t.pageParams}):{pages:[{pagination:e.items}],pageParams:[e.items.prev_cursor??null]})}function nt(e){return B({mutationFn:t=>ue.post(`lc/widget/chats/${e}/submit-form-data`,t).then(s=>s.data),onSuccess:()=>f.invalidateQueries({queryKey:v.conversations.invalidateKey}),onError:t=>E(t)})}function Z(){var e;return((e=Ue(v.customers.get()).data)==null?void 0:e.user)??null}function ge(){return f.getQueryData(v.customers.get().queryKey).user}async function As(e){Is(e)&&ue.post("lc/widget/customers/sync-external-data",e).then(t=>{f.setQueryData(v.customers.get().queryKey,t.data)})}function Is(e){const t=ge();return!!Object.keys(e).some(s=>s==="email"?t.email!==e.email:s==="name"?t.name!==e.name:!0)}function fe({attributeIds:e,information:t,onSubmit:s,submitButtonLabel:i,isPending:a,disabled:r}){const o=Ue(ht.attributes.normalizedList({attributeIds:e,for:"customer"})),l=d.useMemo(()=>e.map(c=>{var u;return(u=o.data)==null?void 0:u.attributes.find(m=>m.id===c)}).filter(c=>!!c),[o.data,e]);return o.isLoading?n.jsx(vt,{}):n.jsx("div",{className:"mb-12 px-16 pt-24",children:n.jsxs("div",{className:"relative rounded-panel border px-16 pb-16 pt-24",children:[n.jsx("div",{className:"absolute -top-20 left-0 right-0 mx-auto h-40 w-40 rounded-full bg-primary p-8 text-on-primary",children:n.jsx(Je,{className:"block"})}),t&&n.jsx("div",{className:"mb-16 text-sm",children:t}),n.jsxs(Ms,{attributes:l,onSubmit:s,children:[l.map((c,u)=>n.jsx(ls,{attribute:c,size:"sm"},`${c.name}:${u}`)),n.jsx(de,{type:"submit",variant:"flat",color:"primary",className:"w-full",disabled:a||r,children:i})]})]})})}function Ms({attributes:e,children:t,onSubmit:s}){const i=Ts(e);return n.jsx(yt,{form:i,className:"space-y-16",onSubmit:s,children:t})}function Ts(e){const t=Z(),s=cs(e);return t&&e.forEach(i=>{const a=i.key;a in t&&(s[i.key]=t[a])}),xt({defaultValues:s})}function Ps({message:e,disabled:t}){var i;const s=nt(e.conversation_id);return!((i=e.body.attributeIds)!=null&&i.length)||e.body.submitted?null:n.jsx(D,{uuid:e.uuid,children:n.jsx(fe,{attributeIds:e.body.attributeIds,information:e.body.message,onSubmit:a=>{s.mutate({type:"collectDetails",values:a})},submitButtonLabel:n.jsx(j,{message:"Submit"}),isPending:s.isPending,disabled:t})})}function _s({align:e="left",avatar:t,color:s="chip",message:i}){return n.jsx(D,{uuid:i.uuid,children:n.jsx(Ve,{align:e,avatar:t,children:n.jsx(He,{color:s,children:n.jsxs("div",{className:"flex min-h-18 min-w-40 items-center justify-center gap-x-4",children:[n.jsx("div",{className:"size-8 animate-[1s_pulse_infinite] rounded-full bg-text-muted"}),n.jsx("div",{className:"size-8 animate-[1s_pulse_infinite_250ms] rounded-full bg-text-muted"}),n.jsx("div",{className:"size-8 animate-[1s_pulse_infinite_500ms] rounded-full bg-text-muted"})]})})})})}function he(e){const t=e.author??"user",s=e.uuid||oe();return{body:e.body,conversation_id:e.conversation_id??0,id:s,uuid:s,type:e.type??"message",created_at:e.created_at??Le().toAbsoluteString(),attachments:e.files??[],user:t==="user"&&O.user?{id:O.user.id,name:O.user.name,image:O.user.image}:null,author:e.author??"user",source:null,is_placeholder:!0,data:e.data}}const Ns=(e,t)=>Ls(Us(Ds(Fs(Es(e,t)))));async function*Es(e,t){if(!e.body)throw Error("Response for endpoint had no body");const s=e.body.pipeThrough(new TextDecoderStream).pipeThrough(new us).getReader();for(s.closed.then(()=>t.abort()),t.signal.addEventListener("abort",()=>s.cancel());!t.signal.aborted;){const{done:i,value:a}=await s.read();if(i){t.abort();break}if(!(!a||!a.event)){if(a.event==="delta")yield{event:a.event,data:JSON.parse(a.data)};else if(a.event==="message"||a.event==="debug"){const r={event:a.event,data:JSON.parse(a.data)};if(r.data.type==="endStream"){t.abort();break}yield r}}}}async function*Fs(e){let t=performance.now(),s=null;const i=600;for await(const a of e){const r=performance.now(),o=r-t;yield a,a.event==="message"&&a.data.type==="typing"&&(!s||s.event!=="message"||s.data.type!=="typing")&&o<i&&await new Promise(l=>setTimeout(l,i-o)),t=r,s=a}}async function*Ds(e){let t="";for await(const s of e){if(s.event!=="delta"){yield s;continue}t+=s.data.delta,yield ks(t)}}async function ks(e){const t=await Ws();return e=e.replaceAll("\\n",`
`),e=e.replace(/-$/,""),{event:"message",data:{type:"formattedHtml",content:t.render(Bs(e))}}}let k;async function Ws(){if(!k){k=(await me(async()=>{const{default:t}=await import("./index-Blr6EMNg.js");return{default:t}},[],import.meta.url)).default();const e=k.renderer.rules.link_open||function(t,s,i,a,r){return r.renderToken(t,s,i)};k.renderer.rules.link_open=function(t,s,i,a,r){return t[s].attrSet("target","_blank"),e(t,s,i,a,r)}}return k}function Bs(e){let t=e;(e.match(/`/g)||[]).length%2!==0&&(t+="`"),(e.match(/```/g)||[]).length%2!==0&&(t+="\n```");const a=e.lastIndexOf("["),r=e.lastIndexOf("]("),o=e.lastIndexOf(")");a!==-1&&(r===-1||o<r)&&(r===-1&&(t+="]("),t+=")");const l=m=>(e.match(new RegExp(`\\${m}`,"g"))||[]).length;return l("*")%2!==0&&(t+="*"),l("_")%2!==0&&(t+="_"),t}async function*Us(e){let t=[];const s=/[a-zA-Z0-9À-ž'`]+$/,i=/^[a-zA-Z0-9À-ž'`]+/;for await(const a of e){if(a.event==="message"&&a.data.type==="endDeltaStream"){for(const o of t)yield o;t=[];continue}if(a.event!=="delta"){yield a;continue}t.push(a);let r=0;for(let o=1;o<t.length;o++){const l=s.test(t[o-1].data.delta),c=i.test(t[o].data.delta),u=l&&c,m=o-r>=5;u&&!m||(yield{event:"delta",data:{delta:t.slice(r,o).map(g=>g.data).join("")}},r=o)}t=t.slice(r)}for(const a of t)yield a}async function*Ls(e){const t=new EventTarget;let s=!1;const i=[],a=[],r=async()=>{const l=await e.next();l.done?s=!0:(i.push(l.value),a.push(performance.now()),r()),t.dispatchEvent(new Event("next"))};r();let o=performance.now();for(;!s||i.length>0;){const l=a.slice(-30),c=2e3,u=l.map((A,se,mt)=>A-mt[se-1]).slice(1).filter(A=>A>c).reduce((A,se)=>A+se,0),g=l.at(-1)-l[0]-u,p=Math.min(200,g/(l.length-1)),y=performance.now()-o;await Promise.race([Ks(Math.max(5,p-y)),qs(t,"next")])||i.length!==0&&(o=performance.now(),yield i.shift())}}const Ks=e=>new Promise(t=>setTimeout(t,e)),qs=(e,t)=>new Promise(s=>e.addEventListener(t,()=>s(!0),{once:!0}));function at(e,t){f.setQueryData(e,s=>{s||(s={pages:[wt],pageParams:[]});const i=s.pages,a=i[0].pagination.data,r=t(a),o=[...i];return o[0]={...i[0],pagination:{...i[0].pagination,data:[...r]}},{...s,pages:o}})}async function*Y(e,t,s){if(!e.ok||!(e!=null&&e.body))return bt(),null;let i=null;for await(const a of Ns(e,t)){if(a.event==="message"){if(a.data.type==="conversationCreated"&&(s=a.data.data.conversation.id),!s)continue;if(a.data.type==="typing"?Os(s):Te(s),a.data.type==="formattedHtml"&&(i=zs(i,s,a.data.content)),a.data.type==="messageCreated"){const r=a.data.message;ee(s,o=>{const l=o.filter(c=>c.type!=="streaming"&&c.type!=="typing"&&!("isPlaceholder"in c));return l.push(r),l})}yield a}a.event==="debug"&&console.log(a.data.type,a.data.data)}s&&Te(s)}function Os(e){let t=Rs(e).find(s=>s.type==="typing");return t||(t=he({conversation_id:+e,body:"",author:"bot",type:"typing"}),K(t.uuid),ee(e,s=>[...s,t])),t}function Te(e){ee(e,t=>t.find(s=>s.type==="typing")?t.filter(s=>s.type!=="typing"):t)}function ee(e,t){at(v.conversations.messages(e).queryKey,t)}function Rs(e){var t;return((t=f.getQueryData(v.conversations.messages(e).queryKey))==null?void 0:t.pages.flatMap(s=>s.pagination.data))??[]}function zs(e,t,s){if(e){e.body=s;const i=document.querySelector(`[data-message-id="${e.id}"] .streaming-message-body`);return i&&requestAnimationFrame(()=>{i.innerHTML=s}),e}else{const i=he({conversation_id:+t,body:s,author:"bot",type:"streaming"});return ee(t,a=>[...a,i]),i}}function it(){return C().sessionId}const Qs=400,$s=16,S={open:{width:`${Qs+$s*2}px`,height:"800px"},closed:{width:"94px",height:"94px"},articleMaximized:{width:"700px",height:"100%"}};let W=null;const te=Ct()((e,t)=>({isAiAgentPreviewMode:!1,setIsAiAgentPreviewMode:s=>e({isAiAgentPreviewMode:s}),activeConversationId:null,setActiveConversationId:s=>e({activeConversationId:s}),widgetState:"closed",activeCampaign:null,widgetClosedAt:null,interactedWithWidget:!1,setWidgetState:(s,i)=>{const a=s==="closed",r=t().widgetState;if(!(r===s&&!i))if(e({activeCampaign:null,interactedWithWidget:!i}),a)W&&clearTimeout(W),e({widgetState:s,widgetClosedAt:i?null:performance.now()}),W=setTimeout(()=>{R({width:S[s].width,height:S[s].height})},300);else{W&&clearTimeout(W);const o=r==="articleMaximized"||s==="articleMaximized";R({width:S[s].width,height:S[s].height},o),setTimeout(()=>{e({widgetState:s,activeCampaign:null,widgetClosedAt:null})})}},showCampaign:s=>{t().activeCampaign||(e({activeCampaign:s}),R({width:`${s.width+32}px`,height:`${s.height+80+16+28}px`}),Vs(s,!1))},hideCampaign:()=>{e({activeCampaign:null}),R({width:S[t().widgetState].width,height:S[t().widgetState].height})}})),x=()=>te.getState();function R(e,t){window.parent.postMessage({source:"livechat-widget",type:"resize",width:e.width,height:e.height,shouldTransition:t},"*")}function Vs(e,t){const{base_url:s}=C().settings;navigator.sendBeacon&&navigator.sendBeacon(`${s}/api/v1/lc/widget/campaigns/${e.id}/imp?_token=${C().csrf_token}`,JSON.stringify({isInteraction:t,sessionId:it()}))}const rt=["create-widget-chat"];function Hs(){const e=X();return B({mutationKey:rt,mutationFn:t=>{t.message&&K(t.message.uuid);const s=new AbortController,i=async a=>{x().setActiveConversationId(a.conversation.id),tt(a.conversation.id,a),await e(`/${x().isAiAgentPreviewMode?"ai-agent-preview-mode":"conversations"}/${a.conversation.id}`,{replace:!0})};return J("lc/widget/chats",Gs(t),s.signal).then(async a=>{for await(const r of Y(a,s))r.event==="message"&&r.data.type==="conversationCreated"&&i(r.data.data)})},onError:t=>E(t),onSuccess:()=>{f.invalidateQueries({queryKey:v.conversations.invalidateKey}),f.invalidateQueries({queryKey:v.customers.invalidateKey})}})}function Gs(e){var s;return{message:e.message?{...e.message,attachments:(s=e.message.attachments)==null?void 0:s.map(i=>i.id)}:void 0,preChatForm:e.preChatForm,flowId:e.flowId,startWithGreeting:e.startWithGreeting}}const ot=["submit-widget-chat-message"];function Xs(){return B({mutationKey:ot,mutationFn:({message:e,conversationId:t})=>{var i;const s=new AbortController;return J(`lc/widget/chats/${t}/messages`,{message:{...e,attachments:(i=e.attachments)==null?void 0:i.map(a=>a.id)}},s.signal).then(async a=>{const r=Y(a,s,t);for await(const o of r);})},onMutate:async e=>{await f.cancelQueries({queryKey:z(e.conversationId)});const t=f.getQueryData(z(e.conversationId));return K(e.message.uuid),at(z(e.conversationId),s=>[...s,he(e.message)]),{previousData:t}},onError:(e,t,s)=>{s!=null&&s.previousData&&f.setQueryData(z(t.conversationId),s.previousData),E(e)},onSuccess:()=>{f.invalidateQueries({queryKey:v.conversations.invalidateKey})}})}function z(e){return v.conversations.messages(e).queryKey}function ve(){const e=Hs(),t=Xs(),s=ds({predicate:o=>o.options.mutationKey===rt||o.options.mutationKey===ot})>0,i=d.useCallback(o=>t.mutateAsync({...o,message:{...o.message,uuid:o.message.uuid||oe()}},{onSuccess:(l,c)=>{x().setActiveConversationId(+c.conversationId)},onError:l=>E(l)}),[]),a=d.useCallback(o=>{var l;return e.mutateAsync({...o,message:o.message?{...o.message,uuid:o.message.uuid||oe()}:void 0,flowId:o.startWithGreeting?(l=N().newChatGreeting)==null?void 0:l.flow_id:null})},[]),r=d.useCallback(o=>o.conversationId?i(o):a({...o,startWithGreeting:!0}),[a,i]);return{submitMessage:i,createChat:a,sendMessageOrCreateChat:r,isPending:s}}function lt(){const{pathname:e}=Ke();return e.startsWith("/ai-agent-preview-mode")}function ct(e){const t=qe(),{sendMessageOrCreateChat:s,isPending:i}=ve(),a=Js(e.conversation_id),r=Zs(e.conversation_id),o=lt();return{handleButtonAction:c=>{var u;switch(c.actionType){case"openUrl":window.open(c.actionValue,"_blank");break;case"copyToClipboard":(u=navigator.clipboard)==null||u.writeText(c.actionValue),Ce(le("Copied to clipboard!"));break;case"goToNode":a.mutate({nodeId:c.actionValue});break;case"setAttributes":r.mutate(c);break;case"openEmbed":if(o){Ce.danger(le("Embed is not available in preview mode"));return}t("/embed",{state:{embedUrl:c.actionValue}});break;default:s({message:{body:c.actionValue||c.name},conversationId:e.conversation_id});break}},isPending:a.isPending||i}}function Js(e){return B({mutationFn:t=>{const s=new AbortController;return J(`conversations/${e}/flows/go-to-node`,t,s.signal).then(async i=>{for await(const a of Y(i,s,e));})},onSuccess:()=>f.invalidateQueries({queryKey:v.conversations.invalidateKey}),onError:t=>E(t)})}function Zs(e){return B({mutationFn:t=>{const s=new AbortController;return J(`conversations/${e}/flows/set-attributes`,{message:t.actionValue,attributes:t.attributes},s.signal).then(async i=>{for await(const a of Y(i,s,e));})},onSuccess:()=>f.invalidateQueries({queryKey:v.conversations.invalidateKey}),onError:t=>E(t)})}function Ys({message:e}){const t=d.useRef(null),[s,i]=d.useState(!0),[a,r]=d.useState(e.body.items.length<=1);return d.useEffect(()=>{const o=t.current;if(o){const l=()=>{i(o.scrollLeft===0),r(o.scrollLeft+o.clientWidth===o.scrollWidth)};return o.addEventListener("scroll",l),()=>{o.removeEventListener("scroll",l)}}},[]),n.jsxs(D,{className:"relative",uuid:e.uuid,children:[n.jsx("div",{className:"hidden-scrollbar mb-12 flex snap-x snap-mandatory items-start gap-14 overflow-x-auto scroll-smooth",ref:t,children:e.body.items.map((o,l)=>n.jsx(en,{item:o,message:e},l))}),n.jsxs("div",{className:"pointer-events-none absolute top-0 flex h-full w-full items-center",children:[n.jsx(Pe,{hidden:s,className:"mr-auto",onClick:()=>{t.current&&t.current.scrollBy({left:-240,behavior:"smooth"})},children:n.jsx(jt,{})}),n.jsx(Pe,{hidden:a,className:"ml-auto",onClick:()=>{t.current&&t.current.scrollBy({left:240,behavior:"smooth"})},children:n.jsx(St,{})})]})]})}function en({item:e,message:t}){const{handleButtonAction:s,isPending:i}=ct(t);return n.jsxs("div",{className:"w-240 flex-shrink-0 snap-center overflow-hidden rounded-panel border shadow-sm",children:[e.image&&n.jsx("img",{src:e.image,alt:"",className:"h-172 w-full rounded-t-panel object-cover"}),n.jsxs("div",{className:"px-20 pb-20 pt-16 text-sm",children:[n.jsx("div",{className:"line-clamp-2 whitespace-pre-wrap break-words font-semibold",children:e.title}),n.jsx("div",{className:"mt-8 line-clamp-4 whitespace-pre-wrap break-words",children:e.description})]}),e.buttons.map((a,r)=>n.jsx("div",{children:n.jsx("button",{disabled:i,className:"h-44 w-full overflow-hidden overflow-ellipsis whitespace-nowrap border-t px-20 text-sm font-semibold text-primary transition-button hover:bg-hover focus-visible:outline-primary-light disabled:bg-disabled disabled:text-disabled",onClick:()=>s(a),children:n.jsx(j,{message:a.name})})},r))]})}function Pe({children:e,onClick:t,hidden:s,className:i}){return n.jsx("button",{className:_("size-36 select-none rounded-full border bg shadow-[0_0_15px_0_rgba(0,0,0,.34)] outline-none transition-[opacity,color] hover:text-primary focus-visible:ring",s?"pointer-events-none opacity-0":"pointer-events-auto",i),onClick:()=>t(),children:e})}function tn({children:e,className:t}){const s=d.Children.toArray(e);return n.jsx("div",{className:_("flex items-center gap-4",t),children:s.map((i,a)=>n.jsxs(d.Fragment,{children:[n.jsx("div",{children:i}),a<s.length-1?n.jsx("div",{children:"•"}):null]},a))})}const sn={policy:"conversationFileEntry",_xChatWidget:"true"};function nn({message:e,color:t,isLastInGroup:s=!0,isLast:i=!0,...a}){var o,l;const r=e.data??{};return n.jsxs(D,{uuid:e.uuid,children:[n.jsxs(Ve,{...a,className:_(s?"mb-12":"mb-4"),avatarInvisible:!s,footer:s?n.jsxs(tn,{children:[e.author==="bot"&&n.jsx(ts,{}),e.created_at&&n.jsx("time",{children:n.jsx(ss,{date:e.created_at})})]}):null,children:[e.body?n.jsx(He,{color:t,allowBreak:!0,children:n.jsx(ms,{isStreaming:e.type==="streaming",addParagraphSpacing:e.author==="bot",children:e.body})}):null,(o=e.attachments)!=null&&o.length?n.jsx(es,{align:a.align,onSelected:c=>{var u;(u=window.open(c.url,"_blank"))==null||u.focus()},attachments:e.attachments,color:t,previewSearchParams:sn}):null]}),!!((l=r.buttons)!=null&&l.length)&&i&&n.jsx(an,{message:e,buttons:r.buttons})]})}function an({buttons:e,message:t}){const{handleButtonAction:s,isPending:i}=ct(t);return n.jsx("div",{className:"mb-24 mt-12 flex flex-wrap justify-end gap-10",children:e==null?void 0:e.map((a,r)=>n.jsx(de,{variant:"outline",color:"primary",className:"max-w-full overflow-hidden overflow-ellipsis shadow",fontWeight:"font-medium",disabled:i,onClick:()=>s(a),children:a.name},r))})}function ut({message:e,isLastInGroup:t=!0,isLast:s=!0}){return e.type==="event"?n.jsx(rn,{event:e}):e.type==="submittedFormData"?n.jsx(on,{message:e}):e.type==="collectDetailsForm"?n.jsx(Ps,{message:e,disabled:!s}):e.type==="cards"?n.jsx(Ys,{message:e}):e.type==="typing"?n.jsx(_s,{message:e,avatar:n.jsx(Me,{message:e,size:"sm"})}):e.type==="message"||e.type==="streaming"?n.jsx(nn,{messageId:e.id,isLastInGroup:t,isLast:s,avatar:e.author!=="user"?n.jsx(Me,{message:e,size:"sm"}):void 0,message:e,align:e.author==="user"?"right":"left",color:e.author==="user"?"primary":"chip"}):null}function rn({event:e}){const t=ns({message:e,variant:"customer"});return t?n.jsxs(D,{uuid:e.uuid,className:"mb-12 text-center text-xs text-muted",children:[n.jsx(j,{...t})," -"," ",n.jsx("time",{className:"inline-block whitespace-nowrap",children:n.jsx(At,{date:e.created_at,preset:"time"})})]}):null}function on({message:e}){return n.jsxs(D,{uuid:e.uuid,className:"mx-16 my-24",children:[n.jsx("div",{className:"relative top-20 mx-auto h-40 w-40 rounded-full bg-primary p-8 text-on-primary",children:n.jsx(Je,{className:"block"})}),n.jsx("div",{className:"space-y-14 rounded-panel border p-24 text-left text-sm",children:e.body.attributes.map(t=>n.jsxs("div",{children:[n.jsx("div",{className:"mb-2 text-muted",children:t.name}),n.jsx("div",{children:n.jsx(os,{attribute:t})})]},t.key))})]})}function ln({chatId:e}){var o,l,c,u;const{isInsideSettingsPreview:t}=U(),{chatWidget:s}=F(),i=(l=(o=s==null?void 0:s.forms)==null?void 0:o.postChat)==null?void 0:l.attributes,a=nt(e);if(!(i!=null&&i.length))return null;const r=m=>{t||a.mutate({type:"postChat",values:m})};return n.jsx("div",{className:"animated-chat-message",children:n.jsx(fe,{attributeIds:i,information:(u=(c=s==null?void 0:s.forms)==null?void 0:c.postChat)==null?void 0:u.information,onSubmit:r,submitButtonLabel:n.jsx(j,{message:"Submit"}),isPending:a.isPending})})}function _e({onSubmit:e,isPending:t}){var r,o,l,c;const{isInsideSettingsPreview:s}=U(),{chatWidget:i}=F(),a=(o=(r=i==null?void 0:i.forms)==null?void 0:r.preChat)==null?void 0:o.attributes;return a!=null&&a.length?n.jsx("div",{className:"animated-chat-message",children:n.jsx(fe,{attributeIds:a,information:(c=(l=i==null?void 0:i.forms)==null?void 0:l.preChat)==null?void 0:c.information,onSubmit:u=>{s||!e||e(u)},submitButtonLabel:n.jsx(j,{message:"Start the chat"}),isPending:t??!1})}):null}function cn({disablePreChatForm:e}){var m;const{state:t}=Ke(),{isInsideSettingsPreview:s,settingsEditorParams:i}=U(),{conversationId:a}=Oe(),{chatWidget:r}=F(),o=(m=r==null?void 0:r.forms)==null?void 0:m.preChat,{isPending:l,createChat:c}=ve(),{newChatGreeting:u}=et();if(a&&!s)return null;if(s){if(i.form==="postChat")return n.jsx(ln,{chatId:0});if(i.form==="preChat")return n.jsx(_e,{})}else if(!e&&!(o!=null&&o.disabled)&&(o!=null&&o.attributes.length)){const g=!(t!=null&&t.messageBody);return n.jsx(_e,{isPending:l,onSubmit:p=>{c({preChatForm:p,message:t!=null&&t.messageBody?{body:t.messageBody,attachments:[]}:void 0,startWithGreeting:g})}})}return n.jsx(un,{})}function un(){const{newChatGreeting:e}=et(),t=d.useRef(!1);return d.useMemo(()=>{t.current||(e==null||e.parts.forEach(s=>{K(s.uuid)}),t.current=!0)},[e==null?void 0:e.parts]),n.jsx(d.Fragment,{children:e==null?void 0:e.parts.map((s,i)=>n.jsx(ut,{message:s,...Ge(i,s,e.parts)},s.uuid))})}function dn(e){return ps({...v.conversations.messages(e),select:as,enabled:!!e})}function mn(e){var a,r;if(e==null)return!1;e.length===0&&(e=((a=N().newChatGreeting)==null?void 0:a.parts)??[]);const t=e.at(-1),s=(t==null?void 0:t.type)==="collectDetailsForm",i=(t==null?void 0:t.type)==="message"&&!!((r=t.data)!=null&&r.preventTyping);return s||i}const pn={policy:"conversationFileEntry",_xChatWidget:"true"};function gn({onClose:e,onSelectFiles:t,maxUploads:s}){const i=w(c=>c.fileUploads),a=w(c=>c.completedUploadsCount),r=w(c=>c.activeUploadsCount),o=w(c=>c.uploadMultiple),l={uploadType:ze.conversationAttachments};return n.jsxs(It,{maxHeight:"max-h-400",shadow:"shadow-lg",children:[n.jsx(Mt,{showDivider:!0,titleTextSize:"text-sm",padding:"px-14 py-10",leftAdornment:r?n.jsx(Re,{isIndeterminate:!0,size:"sm"}):n.jsx(vs,{className:"text-positive"}),closeButtonIcon:n.jsx(Tt,{}),children:n.jsx(j,{message:":completed of :total uploaded",values:{completed:a,total:i.size}})}),n.jsxs(Pt,{padding:"p-14",className:"@container",children:[n.jsxs("div",{className:"mb-12 grid grid-cols-3 gap-10 @[400px]:grid-cols-4",children:[i.size<s&&n.jsx(L,{equalWidth:!0,color:"primary",variant:"outline",radius:"rounded-panel",size:null,className:"aspect-square",onClick:async()=>{const c=Xe(l),u=await Ze({multiple:!0,types:c==null?void 0:c.allowedFileTypes});o(u,l)},children:n.jsx(ys,{})}),n.jsx(fs.Provider,{value:pn,children:[...i].map(([c,u])=>n.jsx(fn,{upload:u,uploadCount:i.size,onClose:e},c))})]}),n.jsx(de,{variant:"flat",color:"primary",className:"w-full",onClick:()=>t(),disabled:!a||r>0,children:n.jsx(j,{message:"Select files"})})]})]})}function fn({upload:e,onClose:t,uploadCount:s}){const i=w(r=>r.abortUpload),a=w(r=>r.removeUpload);return n.jsxs("div",{className:"relative flex aspect-square min-h-0 flex-col rounded-panel border px-6 pb-4 pt-6",children:[n.jsx("div",{className:"m-4 flex min-h-0 flex-auto items-center justify-center overflow-hidden",children:e.entry?n.jsx(hs,{file:e.entry,className:"rounded-panel"}):n.jsx(hn,{file:e.file})}),n.jsx("div",{className:"mt-6 flex-shrink-0 overflow-hidden overflow-ellipsis whitespace-nowrap text-center text-xs",children:e.file.name}),n.jsx(L,{className:"absolute -right-8 -top-8",variant:"flat",radius:"rounded-full",color:"chip",size:"2xs",onClick:()=>{i(e.file.id),a(e.file.id),s<2&&t()},children:n.jsx(Qe,{})})]})}function hn({file:e}){const t=w(o=>o.fileUploads.get(e.id)),s=(t==null?void 0:t.percentage)||0,i=t==null?void 0:t.status,a=t==null?void 0:t.errorMessage;let r;if(i==="failed"){const o=a||le("This file could not be uploaded");r=n.jsx(pe,{variant:"danger",label:n.jsx(Nt,{value:o}),children:n.jsx(_t,{className:"text-danger",size:"md"})})}else i==="aborted"?r=n.jsx(Et,{className:"text-warning",size:"md"}):i==="completed"?r=n.jsx(Ft,{size:"md",className:"text-positive"}):r=n.jsx(Re,{"aria-label":"Upload progress",size:"sm",value:s,isIndeterminate:s<1||s>99});return n.jsx("div",{className:"flex flex-auto items-center justify-center",children:r})}function vn({className:e,size:t,iconSize:s,maxUploads:i=6,disabled:a,inputContainerRef:r}){const[o,l]=d.useState(!1),c=w(p=>p.completedUploadsCount),u=w(p=>p.fileUploads.size>0),m=w(p=>p.uploadMultiple),g={uploadType:ze.conversationAttachments};return n.jsx(d.Fragment,{children:n.jsxs(Dt,{type:"popover",mobileType:"popover",isOpen:o,onOpenChange:p=>l(p),usePortal:!1,placement:"top",offset:14,handleTriggerClick:!1,triggerRef:r,children:[n.jsx(pe,{label:n.jsx(j,{message:"Upload a file"}),children:n.jsx(L,{badge:c?n.jsx(kt,{top:"-top-2",right:"right-2",children:c}):void 0,onClick:async p=>{if(p.stopPropagation(),o)l(!1);else{if(!u){const y=Xe(g),h=await Ze({multiple:!0,types:y==null?void 0:y.allowedFileTypes});m(h.slice(0,i-1),g)}l(!0)}},disabled:a,size:t,className:e,iconSize:s,children:n.jsx(xs,{className:"rotate-[30deg]"})})}),n.jsx(gn,{maxUploads:i,onClose:()=>l(!1),onSelectFiles:()=>{l(!1)}})]})})}function yn({isPending:e,onSubmit:t}){const{hasPermission:s}=Wt(),i=!s("files.create"),{isInsideSettingsPreview:a}=U(),{chatWidget:r}=F(),o=w(h=>h.getCompletedFileEntries),l=w(h=>h.clearInactive),c=d.useRef(null),u=d.useRef(null),[m,g]=d.useState(""),{trans:p}=Bt(),y=async()=>{e||(a?(g(""),l()):(t({body:m,attachments:o()}),g(""),l()))};return n.jsx("form",{ref:u,className:"m-0 flex-shrink-0",onSubmit:h=>{h.stopPropagation(),h.preventDefault(),y()},children:n.jsxs("div",{ref:c,className:"relative overflow-hidden rounded-[24px] bg-elevated shadow-[rgba(0,0,0,0.2)_0px_0px_4px] transition-shadow focus-within:ring dark:shadow-[rgba(255,255,255,0.2)_0px_0px_4px]",children:[n.jsxs("div",{className:"relative max-h-[6em] min-h-48 min-w-0 flex-auto",children:[n.jsx("textarea",{required:!0,className:"compact-scrollbar absolute inset-0 max-h-inherit resize-none border-none bg-transparent py-14 pl-14 pr-96 text-sm text outline-none",value:m,rows:1,onChange:h=>g(h.target.value),placeholder:p({message:(r==null?void 0:r.inputPlaceholder)??"Enter your message here..."}),onKeyDown:h=>{h.key==="Enter"&&(h.preventDefault(),y())}}),n.jsx("div",{className:"invisible max-h-inherit whitespace-pre-line py-14 pl-14 pr-96 text-sm",children:m})]}),n.jsxs("div",{className:"absolute bottom-0 right-0 top-0 flex items-end px-6 pb-6",children:[n.jsx(gs,{onSelected:h=>g(m+h),className:"text-muted",size:"sm"}),!i&&n.jsx(vn,{inputContainerRef:c,className:"text-muted",size:"sm",disabled:a}),n.jsx(pe,{label:n.jsx(j,{message:"Submit"}),children:n.jsx(L,{disabled:e||a,type:"submit",size:"sm",color:"primary",children:n.jsx(ws,{})})})]})]})})}function xn(){const e=d.useRef(!1),t=qe();return d.useEffect(()=>(e.current||(H("X-Chat-Widget","true"),H("X-Ai-Agent-Preview-Mode","true"),x().setIsAiAgentPreviewMode(!0),e.current=!0,G.postLoaded(window.parent)),G.listen(window,{onConversationReset:()=>t("/ai-agent-preview-mode",{replace:!0})})),[]),n.jsxs(Ut,{children:[n.jsx(je,{path:"ai-agent-preview-mode",element:n.jsx(Ne,{})}),n.jsx(je,{path:"ai-agent-preview-mode/:conversationId",element:n.jsx(Ne,{})})]})}function Ne(){var i;const{conversationId:e}=Oe(),t=dn(e),s=((i=t.data)==null?void 0:i.items)??[];return d.useEffect(()=>(G.postConversationIdChanged(window.parent,e??null),()=>{G.postConversationIdChanged(window.parent,null)}),[e]),n.jsxs("div",{className:"flex h-full flex-col",children:[n.jsx(Lt,{}),n.jsx(Kt,{}),n.jsx("div",{className:_("compact-scrollbar flex-auto overflow-y-auto px-20 py-20"),children:n.jsxs(is,{className:"w-full",query:t,children:[n.jsx(cn,{disablePreChatForm:!0}),s.map((a,r)=>n.jsx(ut,{message:a,...Ge(r,a,s)},a.uuid))]})}),n.jsx("div",{className:"mt-20 flex-shrink-0 px-20 pb-16",children:n.jsx(rs,{children:mn(s)?null:n.jsx(wn,{conversationId:e})})})]})}function wn({conversationId:e}){const{createChat:t,submitMessage:s,isPending:i}=ve();return n.jsx(yn,{isPending:i,onSubmit:a=>{e?s({message:a,conversationId:e}):t({message:a,startWithGreeting:!0})}})}function b(e,t,s){switch(e){case P.eq:return t===s;case P.ne:return t!==s;case P.contains:return Ee(t,s);case P.notContains:return!Ee(t,s);case P.gt:return t>s;case P.lt:return t<s;default:return!1}}function Ee(e,t){return typeof e!="string"||typeof t!="string"?!1:e.toLowerCase().includes(t.toLowerCase())}function Fe(e,t){var s,i,a,r,o,l,c,u,m,g;switch(t.name){case"isReturningVisitor":return!!((s=e.user)!=null&&s.is_returning);case"isFirstTimeVisitor":return!((i=e.user)!=null&&i.is_returning);case"timeOnCurrentPage":return b(t.operator,Math.floor((performance.now()-e.currentUrlLoadedAt)/1e3),+t.value);case"timeOnAllPages":return b(t.operator,Math.floor((performance.now()-e.sessionStartedAt)/1e3),+t.value);case"currentPageUrl":return b(t.operator,e.currentUrl,t.value);case"anyVisitedPageUrl":return e.sessionVisits.some(A=>b(t.operator,A.url,t.value));case"neverInteractedWithWidget":return!e.interactedWithWidget;case"numberOfViewedPages":return b(t.operator,e.sessionVisits.length,+t.value);case"userCountry":return b(t.operator,(a=e.user)==null?void 0:a.country,t.value);case"userBrowser":return b(t.operator,(r=e.user)==null?void 0:r.browser,t.value);case"userPlatform":return b(t.operator,(o=e.user)==null?void 0:o.platform,t.value);case"userDevice":return b(t.operator,(l=e.user)==null?void 0:l.device,t.value);case"signedUp":const p=t.value,y=((u=(c=e.user)==null?void 0:c.attributes)==null?void 0:u.signed_up_at)??((m=e.user)==null?void 0:m.created_at);if(!y)return!1;const h=Math.floor((Date.now()-new Date(y).getTime())/864e5);return b(t.operator,h,p);case"attribute":return!t.valueKey||!e.user?!1:b(t.operator,(g=e.user.attributes)==null?void 0:g[t.valueKey],t.value)}}const De=[];let ne=!1,$={currentUrl:"",currentUrlLoadedAt:0,sessionStartedAt:0,sessionVisits:[],user:null,interactedWithWidget:!1};async function V(e){if(e&&($={...$,...e}),$.interactedWithWidget=x().interactedWithWidget,ne||x().widgetState!=="closed"||bn())return;ne=!0;const s=(await jn()).find(i=>{if(Cn(i))return!0});s&&s.enabled&&!De.includes(s.id)&&(De.push(s.id),x().showCampaign(s)),ne=!1}function bn(){const e=x().widgetClosedAt;return e!=null&&performance.now()-e<15e3}function Cn(e){const t=[],s=[];for(const o of e.conditions)o.match_type==="all"?t.push(o):s.push(o);const i={...$,user:ge()},a=t.every(o=>Fe(i,o)),r=s.length?s.some(o=>Fe(i,o)):!0;return a&&r}let Q=null;async function jn(){return Q||(Q=ue.get("lc/widget/campaigns").then(e=>e.data.pagination.data),Q)}let I=null,ae=null;const ke=[];function Sn(){window.addEventListener("message",async e=>{e.data.source==="livechat-loader"&&e.data.type==="navigate"&&(ke.push({url:e.data.url,time:e.data.time}),ae&&clearTimeout(ae),I&&(ie(I,"ended"),I=null),ae=setTimeout(async()=>{I=await An(e.data)},5e3),V({currentUrl:e.data.url,currentUrlLoadedAt:e.data.time,sessionStartedAt:e.data.initialLoadTime,sessionVisits:ke}))}),document.addEventListener("visibilitychange",()=>{I&&(document.visibilityState==="hidden"?ie(I,"ended"):ie(I,"active"))})}async function An({url:e,title:t,referer:s}){return(await(await fetch(`${C().settings.base_url}/api/v1/lc/widget/visits`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":C().csrf_token,"X-Chat-Widget":"true"},body:JSON.stringify({url:e,title:t,referer:s,session_id:it(),started_at:Le().toAbsoluteString()})})).json()).visit}function ie(e,t){const{base_url:s}=C().settings;navigator.sendBeacon&&navigator.sendBeacon(`${s}/api/v1/lc/widget/visits/${e.id}/change-status?_token=${C().csrf_token}&_xChatWidget=true`,JSON.stringify({status:t}))}let re=null;function dt(){const{isInsideSettingsPreview:e}=U();if(re==null){const t=new URLSearchParams(window.location.search).get("inline")==="true";re={isAppearanceEditor:e,isDirect:t,isInline:e||t}}return re}class In extends Cs{constructor(){super(...arguments);xe(this,"isCountInWidgetTitle",!1)}init(){this.initNotifier()}playSound(s){(s==="incomingChat"||s==="message")&&bs(s,"widget")}appIsVisible(){return document.visibilityState==="visible"&&x().widgetState!=="closed"}conversationBelongsToUser(s){return s.user_id===ge().id}addCountToTitle(s){this.isCountInWidgetTitle=!0,this.notifyLoaderOfChanges("addCountToTitle",s)}isCountInTitle(){return this.isCountInWidgetTitle}removeCountFromTitle(){this.isCountInWidgetTitle=!1,this.notifyLoaderOfChanges("removeCountFromTitle")}notifyLoaderOfChanges(s,i){window.parent.postMessage({source:"livechat-widget",type:"unseenChats",action:s,count:i},"*")}}const ye=new In;let We=!1;function Mn(){var t;if(We)return;const e=N();(t=e.activeConversationData)!=null&&t.conversation&&(x().setActiveConversationId(e.activeConversationData.conversation.id),tt(e.activeConversationData.conversation.id,e.activeConversationData)),f.setQueryData(v.customers.get().queryKey,{user:e.user}),ye.init(),We=!0}function Tn(){const{chatWidget:e}=F(),t=d.useMemo(()=>{var a,r;const s=(a=e==null?void 0:e.spacing)!=null&&a.bottom?parseInt(e.spacing.bottom):16,i=(r=e==null?void 0:e.spacing)!=null&&r.side?parseInt(e.spacing.side):16;return{bottom:Math.min(s,16),side:Math.min(i,16)}},[e==null?void 0:e.spacing]);return{paddingBottom:t.bottom,paddingSide:t.side,paddingLeft:(e==null?void 0:e.position)==="left"?t.side:void 0,paddingRight:(e==null?void 0:e.position)==="right"?t.side:void 0,marginLeft:(e==null?void 0:e.position)==="right"?"auto":void 0,marginRight:(e==null?void 0:e.position)==="left"?"auto":void 0}}function Pn(){const{isInline:e,isDirect:t}=dt(),s=te(r=>r.widgetState!=="closed"),i=X(),a=Tn();return t?null:n.jsxs("div",{style:a,className:"relative mt-auto flex-shrink-0 pt-4",children:[n.jsx(Nn,{}),n.jsx(L,{display:"block",onClick:()=>{if(e)return;const r=Ye.getState().unseenConversations;r.length>0&&i(`/conversations/${r[0]}`),x().setWidgetState(x().widgetState==="closed"?"open":"closed")},variant:"raised",color:"primary",radius:"rounded-full",size:"xl",iconSize:"lg",shadow:"chat-toggle-shadow",children:n.jsx(ce,{initial:!1,mode:"wait",children:s&&!e?d.createElement(Se.div,{...Ae,key:"close-icon"},n.jsx(Qe,{size:"lg"})):d.createElement(Se.div,{...Ae,key:"chat-icon"},n.jsx(_n,{}))})})]})}function _n(){const{chatWidget:e}=F();return e!=null&&e.launcherIcon?n.jsx("img",{src:e.launcherIcon,alt:"",className:"m-auto h-34 w-34 object-cover"}):n.jsx(js,{size:"lg"})}function Nn(){const e=te(s=>s.widgetState);return!Ye(s=>s.unseenConversations.length||s.conversationsWithUnseenMessages.length)||e!=="closed"?null:n.jsx("div",{className:"absolute right-14 top-8 h-14 w-14 rounded-full bg-danger"})}function En(){const e=X(),t=Z(),s=$e("/conversations/:conversationId"),i=s!=null&&s.params.conversationId?+s.params.conversationId:null,a=Ss(()=>{f.invalidateQueries({queryKey:v.conversations.invalidateKey})},500);Fn([M.events.conversations.created,M.events.conversations.updated,M.events.conversations.newMessage],(t==null?void 0:t.id)??null,r=>{ye.handleEvent(r),r.messageUuid&&K(r.messageUuid);const o=x().activeConversationId;o&&r.conversations.some(l=>l.id===o&&l.status_category<=Ie.closed)&&x().setActiveConversationId(null),r.event!==M.events.conversations.newMessage&&a(),r.event===M.events.conversations.newMessage&&f.invalidateQueries({queryKey:v.conversations.messages(r.conversations[0].id).queryKey,refetchType:"all"}),r.event===M.events.conversations.created&&r.conversations.some(l=>l.status_category>=Ie.open)&&r.conversations.some(l=>l.type==="chat")&&i!==r.conversations[0].id&&e(`/conversations/${r.conversations[0].id}`)})}function Fn(e,t,s){const i=d.useRef(s);i.current=s,d.useEffect(()=>{if(t)return Zt().listen({channel:M.name,events:e,type:"presence",callback:a=>{a.conversations.every(r=>r.user_id===t)&&i.current(a)}})},[t])}const Dn=d.lazy(()=>me(()=>import("./livechat-popup-DMZoKDEL.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87]),import.meta.url)),kn=d.lazy(()=>me(()=>import("./widget-active-campaign-CQIQFSjD.js"),__vite__mapDeps([88,1,89,52,3,4,5,6,2,42,77,11,12,13,14,15,16,17,7,8,9,10,23,24,25,19,20,21,54,55,56,57,58,59,60,61,62,66,75,78,79,80,39,40,81,82,83,84,71,85,37,86,87]),import.meta.url));let Be=!1;function Wn(){Mn();const e=Z();return lt()?n.jsx(xn,{}):e!=null&&e.banned_at?null:n.jsx(Bn,{})}function Bn(){const{isInline:e,isAppearanceEditor:t}=dt(),s=Z(),i=te(c=>c.widgetState),[a,r]=d.useState(!1),{selectThemeTemporarily:o}=qt(),l=X();return d.useEffect(()=>{if(s&&!Be){Yt("/lc/widget/broadcasting/auth"),H("X-Chat-Widget","true");const c=N().scopedHcCategoryId;if(c&&H("X-Scoped-Hc-Category-Id",`${c}`),Be=!0,s.banned_at){r(!0);return}Ln(C().settings.chatWidget),Sn(),setInterval(()=>V(),1e3),window.addEventListener("message",async y=>{y.data.source==="livechat-loader"&&(y.data.type==="setTheme"?o(y.data.themeId):y.data.type==="setUserData"&&(As(y.data.userData),V()))}),r(!0),!e&&!t&&setTimeout(()=>V());let u=e;const g=new URL(window.location.toString()).searchParams.get("conversationId"),p=x().activeConversationId;g&&g===`${p}`?(u=!0,l(`/conversations/${g}`)):!t&&e&&l(p?`/conversations/${p}`:"/conversations/new"),x().setWidgetState(u?"open":"closed",!0)}},[s,a,e,o,l,t]),En(),n.jsxs(d.Fragment,{children:[!t&&n.jsx(Un,{}),n.jsx("div",{className:_("h-full w-full",e&&"flex items-center justify-center",e&&i==="closed"&&"hidden"),children:n.jsxs("div",{className:_("isolate",a?"flex h-full max-h-full w-full flex-col":"hidden",e&&"mx-auto"),style:e?{width:S[i].width,height:S[i].height}:void 0,children:[n.jsx(ce,{initial:!1,children:(i!=="closed"||e)&&n.jsx(d.Suspense,{children:n.jsx(Dn,{})})}),!e&&n.jsx(ce,{children:n.jsx(d.Suspense,{children:n.jsx(kn,{})})}),n.jsx(Pn,{})]})})]})}function Un(){const e=$e("conversations/*"),t=!!e,s=e==null?void 0:e.params["*"];return d.useEffect(()=>{ye.setPageStatus({activeConversationId:s?+s:null,isInboxOpen:t})},[t,s]),null}function Ln(e){window.parent.postMessage({source:"livechat-widget",type:"bootstrap",widgetConfig:e},"*")}const Kn=(C().settings.html_base_uri??"/")+"lc/widget",qn=n.jsx($t,{basename:Kn,children:n.jsx(Vt,{client:f,children:n.jsxs(Ht,{children:[n.jsx(Gt,{}),n.jsx(Xt,{features:Jt,children:n.jsx(Wn,{})})]})})});Ot("absolute");Rt.createRoot(zt).render(qn);Qt();export{cn as W,te as a,Tn as b,Z as c,v as d,dn as e,ut as f,ln as g,ve as h,yn as i,et as j,N as k,Vs as l,dt as m,mn as s,Hs as u,x as w};
