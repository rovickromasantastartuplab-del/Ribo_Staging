var o=Object.defineProperty;var r=(t,e,s)=>e in t?o(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var i=(t,e,s)=>r(t,typeof e!="symbol"?e+"":e,s);import{h as a}from"./helpdesk-channel-CQKSbeKg.js";import{w as h,x as l}from"./client-DtfdVV77.js";const u=h()(t=>({unseenConversations:[],conversationsWithUnseenMessages:[],setData:(e,s)=>{t({unseenConversations:e,conversationsWithUnseenMessages:s})}}));class C{constructor(){i(this,"intervalId",null);i(this,"unseenConversations",{});i(this,"pageStatus",{isInboxOpen:!1,activeConversationId:null});i(this,"isInitialized",!1)}addUnseenConversation(e){e.unseen||e.unseenMessages?this.unseenConversations[e.id]=e:this.removeUnseenConversation(e.id)}removeUnseenConversation(e){delete this.unseenConversations[e]}setPageStatus(e){this.pageStatus={...this.pageStatus,...e},this.onConversationPageOpenOrDocumentVisibilityChange()}shouldMarkConversationAsSeen(e){return this.appIsVisible()&&(this.pageStatus.isInboxOpen||this.pageStatus.activeConversationId===e.id)}shouldMarkMessagesAsSeen(e){return this.appIsVisible()&&e.id===this.pageStatus.activeConversationId}shouldPlaySound(e){return!this.appIsVisible()||this.pageStatus.activeConversationId!==e}onConversationPageOpenOrDocumentVisibilityChange(){document.visibilityState!=="hidden"&&(this.pageStatus.isInboxOpen&&this.markConversationsAsSeen(),this.pageStatus.activeConversationId&&this.markMessagesAsSeen([this.pageStatus.activeConversationId]))}markConversationsAsSeen(e){(e||Object.keys(this.unseenConversations).map(Number)).forEach(n=>{this.unseenConversations[n].unseen=!1}),this.syncWithStore(),this.maybeStopTitleInterval()}markMessagesAsSeen(e){(e||Object.keys(this.unseenConversations).map(Number)).forEach(n=>{this.unseenConversations[n]&&(this.unseenConversations[n].unseenMessages=!1)}),this.syncWithStore(),this.maybeStopTitleInterval()}handleEvent(e){(e.event===a.events.conversations.created||e.event===a.events.conversations.updated)&&e.conversations.forEach(s=>{if(!this.conversationBelongsToUser(s)||s.status_category<=l.closed){this.removeUnseenConversation(s.id);return}this.unseenConversations[s.id]||(this.addUnseenConversation({id:s.id,unseen:!this.shouldMarkConversationAsSeen(s),unseenMessages:!this.shouldMarkMessagesAsSeen(s)}),this.shouldPlaySound(s.id)&&(s.assignee_id?s.assignee_id&&this.playSound("incomingChat"):this.playSound("queuedVisitor")))}),e.event===a.events.conversations.newMessage&&(this.shouldMarkMessagesAsSeen(e.conversations[0])||(this.addUnseenConversation({id:e.conversations[0].id,unseen:!this.shouldMarkConversationAsSeen(e.conversations[0]),unseenMessages:!this.shouldMarkMessagesAsSeen(e.conversations[0])}),this.playSound("message"))),this.syncWithStore(),this.syncTitleInterval()}syncTitleInterval(){this.maybeStopTitleInterval();const e=Object.entries(this.unseenConversations).filter(([,{unseen:s,unseenMessages:n}])=>s||!this.appIsVisible()&&n).length;e>0&&(this.maybeStopTitleInterval({force:!0}),this.intervalId=setInterval(()=>{this.isCountInTitle()?this.removeCountFromTitle():this.addCountToTitle(e)},1e3))}syncWithStore(){u.getState().setData(Object.entries(this.unseenConversations).filter(([,{unseen:e}])=>e).map(([e])=>Number(e)),Object.entries(this.unseenConversations).filter(([,{unseenMessages:e}])=>e).map(([e])=>Number(e)))}maybeStopTitleInterval({force:e}={}){(e||Object.entries(this.unseenConversations).every(([,{unseen:s}])=>!s))&&(this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.removeCountFromTitle())}initNotifier(){document.addEventListener("visibilitychange",()=>{this.onConversationPageOpenOrDocumentVisibilityChange()}),this.isInitialized=!0}}export{C as W,u};
