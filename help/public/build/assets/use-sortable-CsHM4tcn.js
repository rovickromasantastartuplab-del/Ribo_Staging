import{bA as X,r as h,$ as F}from"./client-DtfdVV77.js";import{$ as M}from"./isScrollable-BSEN4xi5.js";import{d as E,a as D,b as L,c as j,u as K}from"./use-droppable-CpvjuNXE.js";import{$ as Q}from"./useGlobalListeners-BGMP113F.js";function J(e,n){let r=e;for(M(r,n)&&(r=r.parentElement);r&&!M(r,n);)r=r.parentElement;return r||document.scrollingElement||document.documentElement}const U={onDragStart:()=>{},onDragEnter:()=>{},onDragOver:({e,ref:n,item:r,sortSession:t,onDropPositionChange:l})=>{var g;const u=t.dropPosition;let i=null;const d=(g=E.get(r))==null?void 0:g.rect;if(d){const c=d.top+d.height/2;e.clientY<=c?i="before":e.clientY>=c&&(i="after")}if(i!==u){const c=t.sortables.indexOf(r);if(t.dropPosition=i,l==null||l(t.dropPosition),G(t),n.current)if(t.dropPosition==="after")Y(n.current,"bottom",t);else if(c===0)Y(n.current,"top",t);else{const w=t.sortables[c-1],A=E.get(w);A!=null&&A.ref.current&&Y(A.ref.current,"bottom",t)}const f=t.sortables.indexOf(r);if(t.activeIndex===f){t.finalIndex=t.activeIndex;return}(c>t.activeIndex?"after":"before")==="after"?t.finalIndex=t.dropPosition==="before"?f-1:f:t.finalIndex=t.dropPosition==="after"?f+1:f}},onDragEnd:e=>{G(e)}};function G(e){e!=null&&e.linePreviewEl&&(e.linePreviewEl.style.borderBottomColor="",e.linePreviewEl.style.borderTopColor="",e.linePreviewEl=void 0)}function Y(e,n,r){const t="rgb(var(--be-primary))";n==="top"?e.style.borderTopColor=t:e.style.borderBottomColor=t,r&&(r.linePreviewEl=e)}function k(e,n,r){const t=X(n,0,e.length-1),l=X(r,0,e.length-1);if(t===l)return e;const u=e[t],i=l<t?-1:1;for(let d=t;d!==l;d+=i)e[d]=e[d+i];return e[l]=u,e}const V={onDragStart:()=>{},onDragOver:()=>{},onDragEnter:(e,n,r)=>{var l;const t=(l=E.get(e.sortables[r]))==null?void 0:l.ref.current;t&&(W(t,r,n),k(e.sortables,r,n),e.finalIndex=n)},onDragEnd:()=>{}};function W(e,n,r){const t=e.parentElement;if(r<0)t.prepend(e);else{n>-1&&n<=r&&r++;const l=t.children.item(r);l?l.before(e):t.append(e)}}function Z(e,n,r){const t=e.slice();return t.splice(r<0?t.length+r:r,0,t.splice(n,1)[0]),t}const _="transform 0.2s cubic-bezier(0.2, 0, 0, 1)",C={onDragStart:e=>{e.sortables.forEach((n,r)=>{const t=E.get(n);t!=null&&t.ref.current&&(t.ref.current.style.transition=_,(e==null?void 0:e.activeIndex)===r&&(t.ref.current.style.opacity="0.4"))})},onDragEnter:(e,n,r)=>{k(e.sortables,r,n);const t=e.sortables.map(l=>{var u;return(u=E.get(l))==null?void 0:u.rect});e.sortables.forEach((l,u)=>{if(!e)return;const i=Z(t,n,e.activeIndex),d=t[u],g=i[u],c=E.get(l);if(c!=null&&c.ref.current&&g&&d){const f=g.left-d.left,p=g.top-d.top;c.ref.current.style.transform=`translate3d(${f}px, ${p}px, 0)`}}),e.finalIndex=n},onDragOver:()=>{},onDragEnd:e=>{e.sortables.forEach(n=>{const r=E.get(n);r!=null&&r.ref.current&&(r.ref.current.style.transform="",r.ref.current.style.transition="",r.ref.current.style.opacity="",r.ref.current.style.zIndex="")})}};function q(e){const n=new IntersectionObserver(r=>{r.forEach(t=>{const{width:l,height:u,left:i,top:d}=t.boundingClientRect,[g,c]=[...e].find(([,p])=>p.ref.current===t.target)||[];if(g==null||c==null)return;const f={width:l,height:u,left:i,top:d};e.set(g,{...c,rect:f})}),n.disconnect()});[...e.values()].forEach(r=>{r.ref.current&&n.observe(r.ref.current)})}let z=null;function H(e){z=e}function B({e,rect:n,deltaX:r,deltaY:t}){return{rect:n,x:e.clientX,y:e.clientY,deltaX:r??0,deltaY:t??0,nativeEvent:e}}function S(e){return{left:e.left,top:e.top,width:e.width,height:e.height}}function ee({id:e,disabled:n,ref:r,preview:t,hidePreview:l,...u}){const i=h.useRef(null),{addGlobalListener:d,removeAllGlobalListeners:g}=Q(),c=h.useRef({lastPosition:{x:0,y:0}}).current,f=h.useRef(u);f.current=u,h.useLayoutEffect(()=>(n?D.delete(e):D.set(e,{...D.get(e),id:e,ref:r,type:f.current.type,getData:f.current.getData}),()=>{D.delete(e)}),[e,n,f,r]);const p=o=>{j.forEach(s=>{var b;s.type===((b=D.get(e))==null?void 0:b.type)&&o(s)})},w=o=>{var v,I;o.stopPropagation();const s=D.get(e),b=r.current,y=!i.current||!c.clickedEl||i.current.contains(c.clickedEl);if(z||!b||!s||!y){o.preventDefault(),o.stopPropagation();return}q(E),H("drag"),l&&te(o),o.dataTransfer.effectAllowed="move",c.lastPosition={x:o.clientX,y:o.clientY},c.currentRect=S(b.getBoundingClientRect());const x=B({rect:c.currentRect,e:o});t!=null&&t.current&&t.current(s,m=>{o.dataTransfer.setDragImage(m,0,0)}),L.status="dragging",L.dragTargetId=e,r.current&&(r.current.dataset.dragging="true"),(I=(v=f.current).onDragStart)==null||I.call(v,x,s),requestAnimationFrame(()=>{p(m=>{var $;return($=m.onDragStart)==null?void 0:$.call(m,x,s)})}),d(window,"dragover",A,!0)},A=o=>{var I,m;if(o.stopPropagation(),o.preventDefault(),!c.currentRect)return;const s=o.clientX-c.lastPosition.x,b=o.clientY-c.lastPosition.y,y={...c.currentRect,left:c.currentRect.left+s,top:c.currentRect.top+b},x=B({rect:y,e:o,deltaX:s,deltaY:b}),v=D.get(e);v&&((m=(I=f.current).onDragMove)==null||m.call(I,x,v),p($=>{var N;return(N=$.onDragMove)==null?void 0:N.call($,x,v)})),c.lastPosition={x:o.clientX,y:o.clientY},c.currentRect=y};return{draggableProps:{draggable:!n,onDragStart:w,onDragEnd:o=>{var y,x;if(o.stopPropagation(),g(),!c.currentRect)return;H(null),O&&O.remove();const s=B({rect:c.currentRect,e:o}),b=D.get(e);b&&((x=(y=f.current).onDragEnd)==null||x.call(y,s,b),p(v=>{var I;return(I=v.onDragEnd)==null?void 0:I.call(v,s,b,L.status)})),requestAnimationFrame(()=>{L.dragTargetId=void 0,L.status="inactive",r.current&&delete r.current.dataset.dragging})},onPointerDown:o=>{c.clickedEl=o.target}},dragHandleRef:i}}let O;function te(e){O||(O=new Image,document.body.append(O),O.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),e.dataTransfer.setDragImage(O,0,0)}let a=null;const T={line:U,liveSort:C,moveNode:V};function le({item:e,items:n,type:r,ref:t,onSortEnd:l,onSortStart:u,onDragEnd:i,preview:d,disabled:g,onDropPositionChange:c,strategy:f="liveSort"}){h.useEffect(()=>{!g&&(a==null?void 0:a.type)===r&&a.sortables.length!==n.length&&(a.sortables=[...n],a.activeIndex=n.indexOf(e))},[n,e]);const{draggableProps:p,dragHandleRef:w}=ee({id:e,ref:t,type:r,preview:d,disabled:g,onDragStart:()=>{var P;a={type:r,sortables:[...n],activeSortable:e,activeIndex:n.indexOf(e),finalIndex:n.indexOf(e),dropPosition:null,ref:t,scrollParent:t.current?J(t.current):void 0,scrollListener:()=>{q(E)}},T[f].onDragStart(a),u==null||u(),(P=a.scrollParent)==null||P.addEventListener("scroll",a.scrollListener)},onDragEnd:P=>{var R;a&&(a.dropPosition=null,c==null||c(a.dropPosition),a.activeIndex!==a.finalIndex&&(l==null||l(a.activeIndex,a.finalIndex)),(R=a.scrollParent)==null||R.removeEventListener("scroll",a.scrollListener),T[f].onDragEnd(a),i==null||i(),a=null)},getData:()=>{}}),{droppableProps:A}=K({id:e,ref:t,types:[r],disabled:g,allowDragEventsFromItself:!0,onDragOver:(P,R)=>{a&&T[f].onDragOver({e:R,ref:t,item:e,sortSession:a,onDropPositionChange:c})},onDragEnter:()=>{if(!a)return;const P=a.sortables.indexOf(e),R=a.sortables.indexOf(a.activeSortable);T[f].onDragEnter(a,P,R)},onDragLeave:()=>{a&&(a.dropPosition=null,c==null||c(a.dropPosition))}});return{sortableProps:{...F(p,A)},dragHandleRef:w}}export{k as a,Z as m,le as u};
