import{r as x,ac as M,X as U,l as T,m as b,bD as E,al as z,j as e,am as L,an as q,T as r,ap as B,aa as H,az as j,aq as K,B as D,i as W,s as Q,k as G,q as _,t as X,a1 as J,ae as Y,p as P,aw as Z,ax as ee,ay as se,av as ae}from"./client-DtfdVV77.js";import{g as te}from"./get-default-values-for-form-with-attributes-htMbgWW2.js";import{g as ne,C as re}from"./campaign-conditions-config-DZmli5NZ.js";import{S as ie}from"./select-D9niWe2H.js";import{E as oe}from"./Event-DDJ424UR.js";import{T as le,N as ce}from"./ToggleOn-DbVFGpQu.js";import{T as me}from"./TextFields-CM1xUWDR.js";import{A as ue}from"./Add-B1HfWgJf.js";import{N as de,R as pe,m as ge,b as xe}from"./index-uUjpwT6n.js";import{D as fe}from"./DataObject-3cjjRxnv.js";var i=(s=>(s.CollectedData="collectedData",s.AiAgentTool="aiAgentTool",s.AiAgentSession="aiAgentSession",s.User="user",s.Conversation="conversation",s.PageVisit="pageVisit",s))(i||{});const ye=x.createContext([]),be=[],je=["description"],he=[{name:"signedUp",displayName:b("Signed up")},{name:"browser",displayName:b("Browser")},{name:"device",displayName:b("Device")},{name:"platform",displayName:b("Platform")}],Ce=[{name:"latestUserMessage",displayName:b("Latest user message"),operators:E}],ve=["isReturningVisitor","isFirstTimeVisitor","timeOnCurrentPage","timeOnAllPages","currentPageUrl","anyVisitedPageUrl","numberOfViewedPages"];function A({showReadonly:s=!1,showPageVisitAttributes:d=!1}={}){const{trans:t}=M(),{data:g}=U(T.attributes.normalizedList({for:"agent"})),l=(g==null?void 0:g.attributes)??be,p=x.use(ye)??[],{allItems:c,filteredItems:o,groupedItems:f}=x.useMemo(()=>{let n=[];const y=te(l);l.filter(a=>!je.includes(a.key)).forEach(a=>{n.push({name:a.key,displayName:t({message:a.name}),type:a.type,key:`${a.type}.${a.key}`,attribute:a,operators:ne(a),defaultValue:y[a.key]})}),ve.forEach(a=>{const u=re[a];n.push({name:a,displayName:t(u.label),type:i.PageVisit,key:`${i.PageVisit}.${a}`,defaultValue:u.defaultValue,operators:u.operators,inputConfig:u.inputConfig?{type:u.inputConfig.type,description:u.inputConfig.description?t(u.inputConfig.description):void 0}:void 0,isReadonly:!0})}),he.forEach(a=>{n.push({name:a.name,displayName:t(a.displayName),type:i.User,key:`${i.User}.${a.name}`,isReadonly:!0})}),Ce.forEach(a=>{n.push({name:a.name,displayName:t(a.displayName),type:i.Conversation,key:`${i.Conversation}.${a.name}`,isReadonly:!0,operators:"operators"in a?a.operators:E})}),p.forEach(a=>{n.find(u=>u.key===a.key)||n.push(a)});const h={};Object.values(i).forEach(a=>{h[a]=[]});const v=n.filter(a=>(s||!a.isReadonly)&&(d||a.type!==i.PageVisit));return v.forEach(a=>{h[a.type].push(a)}),{allItems:n,filteredItems:v,groupedItems:h}},[l,p,s,t]),m=x.useCallback(n=>n?c.find(y=>y.name===n.name&&y.type===n.type):null,[c]);return{groupedItems:f,items:o,getItem:m}}function Ne(){const{close:s,formId:d}=z(),[t,g]=x.useState(""),[l,p]=x.useState("text"),{items:c}=A(),o=Ie(),f=m=>{if(m.preventDefault(),m.stopPropagation(),c.some(n=>n.name===t)){X.danger(b("This name is already in use"));return}o.mutate({name:t,format:l,type:i.AiAgentSession,permission:"userCanView"},{onSuccess:()=>{s({name:t,type:i.AiAgentSession})}})};return e.jsxs(L,{children:[e.jsx(q,{children:e.jsx(r,{message:"Create custom attribute"})}),e.jsx(B,{children:e.jsxs("form",{id:d,onSubmit:f,children:[e.jsx(H,{autoFocus:!0,required:!0,label:e.jsx(r,{message:"Name"}),value:t,onChange:m=>g(m.target.value),className:"mb-20"}),e.jsxs(ie,{selectionMode:"single",name:"format",className:"mb-20",label:e.jsx(r,{message:"Format"}),selectedValue:l,onSelectionChange:m=>p(m),children:[e.jsx(j,{value:"text",startIcon:e.jsx(me,{size:"sm"}),children:e.jsx(r,{message:"Text"})}),e.jsx(j,{value:"switch",startIcon:e.jsx(le,{size:"sm"}),children:e.jsx(r,{message:"Toggle"})}),e.jsx(j,{value:"number",startIcon:e.jsx(ce,{size:"sm"}),children:e.jsx(r,{message:"Number"})}),e.jsx(j,{value:"date",startIcon:e.jsx(oe,{size:"sm"}),children:e.jsx(r,{message:"Date"})})]})]})}),e.jsxs(K,{children:[e.jsx(D,{onClick:()=>s(),children:e.jsx(r,{message:"Cancel"})}),e.jsx(D,{variant:"flat",color:"primary",type:"submit",form:d,disabled:o.isPending,children:e.jsx(r,{message:"Create"})})]})]})}function Ie(){return W({mutationFn:s=>G.post("helpdesk/attributes",s),onSuccess:()=>{_.invalidateQueries({queryKey:T.attributes.invalidateKey})},onError:s=>Q(s)})}function Ae({value:s,onChange:d,children:t,className:g,showReadonly:l,showPageVisitAttributes:p,onAddNewAttribute:c,floatingWidth:o="matchTrigger",label:f,description:m,size:n="md",required:y,display:h="block",...v}){var k;const a=J({size:n,inputDisplay:"flex items-center justify-between"}),[u,V]=x.useState(!1),{groupedItems:O,getItem:w}=A({showReadonly:l,showPageVisitAttributes:p}),F=s?(k=w(s))==null?void 0:k.displayName:void 0,R=t||e.jsxs("button",{type:"button",className:a.input,children:[F??e.jsx("span",{className:"font-normal text-main/50",children:e.jsx(r,{message:"Select attribute"})}),e.jsx(Y,{size:n,className:"-mr-4 text-muted"})]}),S=s?`${s.type}.${s.name}`:void 0;return e.jsxs("div",{className:P(g,"relative",h),children:[f&&e.jsx("div",{className:a.label,children:f}),e.jsxs(Z,{...v,floatingWidth:o,showSearchField:!0,selectedValue:S,selectionMode:"single",showCheckmark:!0,floatingMinWidth:"min-w-280",floatingMaxHeight:600,children:[R,e.jsx(ee,{children:Object.entries(O).map(([N,$])=>{const I=N;return e.jsxs(se,{label:e.jsx(Ve,{group:I}),children:[$.map(C=>e.jsx(j,{value:C.key,onSelected:()=>d==null?void 0:d({name:C.name,type:C.type}),children:C.displayName},C.key)),I==="aiAgentSession"&&!!c&&e.jsx(j,{value:"createAttribute",startIcon:e.jsx(ue,{size:"sm"}),onSelected:()=>V(!0),children:e.jsx(r,{message:"Add attribute"})})]},I)})})]}),m&&e.jsx("div",{className:a.description,children:m}),e.jsx(ae,{type:"modal",isOpen:u,onOpenChange:V,onClose:N=>{N&&(c==null||c(N))},children:e.jsx(Ne,{})}),y?e.jsx("input",{"aria-hidden":!0,tabIndex:-1,required:!0,value:S??"",className:"pointer-events-none absolute bottom-0 left-0 w-full opacity-0",onChange:()=>{}}):null]})}function Ve({group:s}){switch(s){case i.User:return e.jsx(r,{message:"User data"});case i.Conversation:return e.jsx(r,{message:"Conversation data"});case i.AiAgentSession:return e.jsx(r,{message:"AI Agent"});case i.PageVisit:return e.jsx(r,{message:"Page visits"});case i.AiAgentTool:return e.jsx(r,{message:"List item data"});case i.CollectedData:return e.jsx(r,{message:"Collected data"})}}function Se(s){const d=x.useRef(null),t={name:s.node.attrs.name,type:s.node.attrs.type},{getItem:g}=A(),l=g(t),p=s.getPos()??0,c=s.editor.state.selection.from===p&&s.editor.state.selection.to===p+s.node.nodeSize;return e.jsx(xe,{as:"span",className:"contents",children:e.jsx(Ae,{display:"inline-block",showReadonly:!0,dontBindEventsToTrigger:!0,floatingWidth:"auto",value:t,onChange:o=>{s.updateAttributes({name:o.name,type:o.type})},isOpen:c,onOpenChange:o=>{o||s.editor.commands.focus(p+s.node.nodeSize)},children:e.jsxs("span",{ref:d,onClick:o=>{o.stopPropagation(),o.preventDefault()},className:P("m-2 inline-flex w-max cursor-pointer select-none items-center gap-8 rounded-full border px-6 align-middle text-sm font-medium transition-colors",c?"bg-primary text-on-primary":"bg-chip"),children:[e.jsx(fe,{size:"xs"}),(l==null?void 0:l.displayName)||t.name]})})})}const Me=de.create({name:"beVariable",selectable:!0,group:"inline",inline:!0,atom:!0,addAttributes(){return{name:{},type:{},fallback:{}}},parseHTML(){return[{tag:"be-variable"}]},renderHTML({HTMLAttributes:s}){return["be-variable",ge(s)]},renderText({node:s}){return`<be-variable name="${s.attrs.name}" type="${s.attrs.type}" fallback="${s.attrs.fallback?s.attrs.fallback:""}"></be-variable>`},addNodeView(){return pe(Se,{className:"contents"})}});export{Ae as A,Me as V,i as a,ye as b,A as u};
