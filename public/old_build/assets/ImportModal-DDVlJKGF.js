import{r as i,j as e}from"./ui-C-VW1P-5.js";import{u as F,D as E,l as q,n as O,o as T,r as A,B as w,t as l,S as R,L as V,I as z}from"./app-BQKKzqf3.js";import{S as H,a as K,b as U,c as X,d as M}from"./select-ivmaqUw7.js";import{A as G,a as J}from"./alert-Bt8OE1Tt.js";import{I as Q}from"./info-ZEKNfV81.js";import{D as W}from"./download-CUJ4p28I.js";function Y({isOpen:g,onClose:f,excelColumns:j,databaseFields:m,importRoute:v,data:c,previewData:D=[]}){const{t:o}=F(),[r,y]=i.useState({}),[b,d]=i.useState(!1);i.useEffect(()=>{if(g&&j.length>0){const a={};m.forEach(t=>{const n=j.find(s=>s.toLowerCase().replace(/[_\s]/g,"")===t.key.toLowerCase().replace(/[_\s]/g,""));n&&(a[t.key]=n)}),y(a)}},[g,j,m]);const N=()=>{if(!c||c.length===0){l.error(o("No data available for import"));return}const t=m.filter(s=>s.required).filter(s=>!r[s.key]);if(t.length>0){l.error(o("Please map all required fields: {{fields}}",{fields:t.map(s=>s.key).join(", ")}));return}const n=(c||[]).map(s=>{const p={};return Object.entries(r).forEach(([S,k])=>{p[S]=s[k]}),p});d(!0),l.loading(o("Importing...")),R.post(route(v),{data:n},{preserveState:!0,onSuccess:s=>{f(),d(!1),l.dismiss(),s.props.flash.success?l.success(o(s.props.flash.success)):s.props.flash.error&&l.error(o(s.props.flash.error))},onError:s=>{d(!1),l.dismiss(),typeof s=="string"?l.error(s):l.error(o("Failed to import"))}})};return e.jsx(E,{open:g,onOpenChange:a=>!a&&f(),modal:!1,children:e.jsxs(q,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx(O,{children:e.jsx(T,{children:o("Import Customers")})}),e.jsxs(G,{className:"bg-amber-50 border-amber-200",children:[e.jsx(Q,{className:"h-4 w-4 text-amber-600"}),e.jsx(J,{className:"text-amber-800",children:o("Map your CSV columns to database fields")})]}),e.jsxs("div",{className:"flex-1 overflow-auto",children:[e.jsx("h3",{className:"text-sm font-semibold mb-3",children:o("Map Excel Columns to Database Fields")}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsx("tr",{children:m.map(a=>e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-700",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:[a.key,a.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsxs(H,{value:r[a.key]||"__unselect__",onValueChange:t=>{y(n=>{const s={...n};return t==="__unselect__"?delete s[a.key]:(Object.keys(s).forEach(p=>{s[p]===t&&delete s[p]}),s[a.key]=t),s})},children:[e.jsx(K,{className:"h-8 text-xs w-full",children:e.jsx(U,{placeholder:o("Select column...")})}),e.jsxs(X,{position:"popper",className:"z-[9999]",children:[e.jsx(M,{value:"__unselect__",children:o("Select column...")}),j.map(t=>{const n=Object.values(r).includes(t)&&r[a.key]!==t;return e.jsx(M,{value:t,disabled:n,children:t},t)})]})]})]})},a.key))})}),e.jsx("tbody",{children:D.slice(0,2).map((a,t)=>e.jsx("tr",{className:"border-b",children:m.map(n=>e.jsx("td",{className:"px-4 py-2 text-gray-600",children:r[n.key]?a[r[n.key]]||o("No data"):o("-")},n.key))},t))})]})})]}),e.jsxs(A,{children:[e.jsx(w,{type:"button",variant:"outline",onClick:f,disabled:b,children:o("Back")}),e.jsx(w,{type:"button",onClick:N,disabled:b,children:o("Import Data")})]})]})})}function ae({isOpen:g,onClose:f,title:j,importRoute:m,parseRoute:v,samplePath:c,importNotes:D,databaseFields:o}){const{t:r}=F(),[y,b]=i.useState(null),[d,N]=i.useState(!1),[a,t]=i.useState(!1),[n,s]=i.useState([]),[p,S]=i.useState([]),[k,C]=i.useState([]),L=async u=>{var _;if(u.preventDefault(),!y){l.error(r("Please select a file to import"));return}const x=new FormData;x.append("file",y),N(!0),l.loading(r("Parsing file..."));try{const h=await(await fetch(route(v),{method:"POST",body:x,headers:{"X-CSRF-TOKEN":((_=document.querySelector('meta[name="csrf-token"]'))==null?void 0:_.getAttribute("content"))||""}})).json();h.excelColumns&&h.previewData?(console.log("Import data",h.previewData),s(h.excelColumns),S(h.previewData),C(h.previewData.slice(0,3)||[]),l.dismiss(),f(),t(!0)):(l.dismiss(),l.error(h.message||r("Failed to parse file")))}catch{l.dismiss(),l.error(r("Network error or invalid response"))}finally{N(!1)}},B=()=>{t(!1),b(null),s([]),S([]),C([])},I=()=>{!d&&!a&&(b(null),f())};return e.jsxs(e.Fragment,{children:[e.jsx(E,{open:g,onOpenChange:I,children:e.jsxs(q,{className:"sm:max-w-md",children:[e.jsx(O,{children:e.jsx(T,{children:j})}),e.jsxs("div",{className:"space-y-4",children:[c&&e.jsx("div",{className:"text-center",children:e.jsxs(w,{type:"button",variant:"outline",onClick:async()=>{try{const u=await fetch(c);if(!u.ok){const x=await u.json();l.error(r(x.error||"Failed to download template"));return}window.location.href=c}catch{l.error(r("Failed to download template"))}},disabled:!c,className:"mb-4",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),r("Download Template")]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{htmlFor:"file",children:[r("Select File")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(z,{id:"file",type:"file",accept:".xlsx,.xls,.csv",onChange:u=>{var x;return b(((x=u.target.files)==null?void 0:x[0])||null)},disabled:d,required:!0})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-3",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:r("Import Notes:")}),e.jsx("p",{className:"text-xs text-blue-700",children:D})]})]}),e.jsxs(A,{children:[e.jsx(w,{type:"button",variant:"outline",onClick:I,disabled:d,children:r("Cancel")}),e.jsx(w,{type:"button",onClick:L,disabled:d,children:r("Import")})]})]})}),e.jsx(Y,{isOpen:a,onClose:B,excelColumns:n,databaseFields:o,importRoute:m,data:p,previewData:k})]})}export{ae as I};
