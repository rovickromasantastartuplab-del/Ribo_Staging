name: Auto Deploy to Staging (cPanel)

on:
  push:
    branches:
      - develop  # Trigger on push to develop branch

jobs:
  deploy:
    runs-on: ubuntu-latest  # Use the latest Ubuntu runner

    steps:
    # Step 1: Clone repository manually
    - name: Clone repository
      run: |
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} repo
        cd repo
        git checkout develop
        shopt -s dotglob
        # Stay inside repo for all next steps

    # Step 2: Install Node.js manually using nvm
    - name: Install Node.js
      run: |
        export NVM_DIR="$HOME/.nvm"
        curl -sL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 20
        node -v
        npm -v
      working-directory: repo

    # Step 3: Install Node dependencies
    - name: Install Node dependencies
      run: npm install
      working-directory: repo

    # Step 4: Build frontend
    - name: Build frontend
      run: npm run build
      working-directory: repo

    # Step 5: Create temporary .env file for Composer (SQLite)
    - name: Create temporary dummy .env for Composer (SQLite)
      run: |
        echo "APP_NAME=ribo" > .env
        echo "APP_ENV=local" >> .env
        echo "APP_KEY=dummydummykeydummykey" >> .env
        echo "APP_DEBUG=true" >> .env
        echo "APP_URL=http://localhost" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        echo "DB_DATABASE=/tmp/database.sqlite" >> .env
        touch /tmp/database.sqlite
      working-directory: repo

    # Step 6: Create Laravel cache directories to avoid "valid cache path" errors
    - name: Create Laravel cache directories
      run: |
        mkdir -p bootstrap/cache
        mkdir -p storage/framework/cache
        mkdir -p storage/framework/views
        mkdir -p storage/framework/sessions
        mkdir -p storage/logs
        chmod -R 777 bootstrap/cache storage
      working-directory: repo

    # Step 7: Install Composer manually and run install
    - name: Install Composer dependencies
      run: |
        mkdir -p $HOME/bin
        EXPECTED_SIGNATURE=$(curl -s https://composer.github.io/installer.sig)
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        ACTUAL_SIGNATURE=$(php -r "echo hash_file('sha384', 'composer-setup.php');")
        if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
          >&2 echo 'ERROR: Invalid installer signature'
          exit 1;
        fi
        php composer-setup.php --install-dir=$HOME/bin --filename=composer
        php -r "unlink('composer-setup.php');"
        export PATH="$HOME/bin:$PATH"
        composer install --no-dev --optimize-autoloader
      working-directory: repo

    # Step 8: Setup SSH (use GitHub secret)
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        printf "%s" "${{ secrets.CPANEL_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H 160.153.176.66 >> ~/.ssh/known_hosts

    # Step 9: Deploy to cPanel via Rsync (over SSH)
    - name: Deploy via SFTP
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: 160.153.176.66
        username: ribocrm
        key: ${{ secrets.CPANEL_SSH_KEY }}
        port: 22
        local-dir: 'repo'
        remote-dir: '/home/ribocrm/staging'
        exclude: |
          .git*
          .github
          node_modules
          tests
          phpunit.xml
          storage/*.key
          .env