name: Auto Deploy to Staging (cPanel)

on:
  push:
    branches:
      - develop  # Trigger on push to develop branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: develop

    # Step 2: Setup Node.js via nvm
    - name: Install Node.js
      run: |
        export NVM_DIR="$HOME/.nvm"
        curl -sL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 20
        node -v
        npm -v

    # Step 3: Install Node dependencies & build frontend
    - name: Install Node dependencies and build
      run: |
        npm ci
        npm run build

    # Step 4: Create temporary .env for Laravel (SQLite)
    - name: Create dummy .env
      run: |
        echo "APP_NAME=ribo" > .env
        echo "APP_ENV=local" >> .env
        echo "APP_KEY=dummydummykeydummykey" >> .env
        echo "APP_DEBUG=true" >> .env
        echo "APP_URL=http://localhost" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        echo "DB_DATABASE=/tmp/database.sqlite" >> .env
        touch /tmp/database.sqlite

    # Step 5: Create Laravel storage & cache directories
    - name: Prepare Laravel directories
      run: |
        mkdir -p bootstrap/cache storage/framework/{cache,views,sessions} storage/logs
        chmod -R 777 bootstrap/cache storage

    # Step 6: Install Composer
    - name: Install Composer
      run: |
        EXPECTED_SIGNATURE=$(curl -s https://composer.github.io/installer.sig)
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        ACTUAL_SIGNATURE=$(php -r "echo hash_file('sha384', 'composer-setup.php');")
        if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
          >&2 echo 'ERROR: Invalid installer signature'
          exit 1
        fi
        php composer-setup.php --install-dir=$HOME/bin --filename=composer
        php -r "unlink('composer-setup.php');"
        export PATH="$HOME/bin:$PATH"
        composer install --no-dev --optimize-autoloader

    # Step 7: Setup SSH for rsync
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        # Convert key to PEM format for compatibility
        echo "${{ secrets.CPANEL_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H 160.153.176.66 >> ~/.ssh/known_hosts
        # Force using PEM format if necessary
        ssh-keygen -p -m PEM -f ~/.ssh/id_ed25519 -N ""

    # Step 8: Deploy to cPanel via Rsync over SSH
    - name: Deploy to cPanel
      run: |
        rsync -avz --delete \
        -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
        --exclude='.git' \
        --exclude='.github' \
        --exclude='node_modules' \
        --exclude='.env' \
        --exclude='storage/' \
        --exclude='public/storage' \
        ./ \
        ribocrm@160.153.176.66:/home/ribocrm/staging