# Triggering deployment on push to develop
name: Auto Deploy to Staging (cPanel via SFTP)

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: Checkout Code
      uses: actions/checkout@v4

    # Step 2: Setup PHP
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, intl, bcmath, fileinfo
        coverage: none

    # Step 3: Setup Node.js
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # Step 4: Prepare Laravel Storage
    - name: Create Storage Directories
      run: |
        mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views storage/logs
        chmod -R 775 storage

    # Step 5: Create Dummy .env for local build
    - name: Create dummy .env
      run: |
        echo "APP_ENV=production" > .env
        echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        echo "DB_DATABASE=:memory:" >> .env
        echo "CACHE_STORE=array" >> .env
        echo "SESSION_DRIVER=array" >> .env
        echo "QUEUE_CONNECTION=sync" >> .env
        echo "MAIL_MAILER=array" >> .env

    # Step 6: Install PHP dependencies
    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-progress

    # Step 7: Install Node dependencies & build frontend
    - name: Install & Build Frontend
      run: |
        npm ci
        npm run build

    # Step 8: Optimize Laravel caches locally
    - name: Optimize Laravel
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    # Step 9: Deploy to cPanel via SFTP
    - name: Deploy via SFTP
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: 160.153.176.66
        username: ribocrm
        # Use private key for auth
        port: 22
        key: ${{ secrets.CPANEL_SSH_KEY }}
        local-dir: './'
        remote-dir: '/home/ribocrm/staging'
        exclude: |
          .git*
          .github
          node_modules
          tests
          phpunit.xml
          storage/*.key
          .env