name: Auto Deploy to Staging (cPanel)

on:
  push:
    branches:
      - develop  # Trigger on push to develop branch

jobs:
  deploy:
    runs-on: ubuntu-latest  # Use the latest Ubuntu runner

    steps:
    # Step 1: Clone repository manually
    - name: Clone repository
      run: |
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} repo
        ls -la  # List the files after cloning to see if 'repo' folder exists
        cd repo
        git checkout develop
        shopt -s dotglob
        cd ..  # Go back to the previous directory
        ls -la  # List files after going back to ensure the 'repo' folder was created

    # Step 2: Install Node.js manually using nvm
    - name: Install Node.js
      run: |
        curl -sL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 20
        node -v
        npm -v

    # Step 3: Install Node dependencies
    - name: Install Node dependencies
      run: |
        ls -la  # List the files to check the current directory
        cd repo  # Change to the 'repo' folder where package.json should be
        ls -la  # Check if package.json is in the 'repo' directory
        npm install  # Run npm install inside the 'repo' folder

    # Step 4: Build frontend
    - name: Build frontend
      run: |
        cd repo  # Ensure we are inside the 'repo' folder
        npm run build  # Build the frontend

    # Step 5: Create temporary .env file for Composer (SQLite)
    - name: Create temporary dummy .env for Composer (SQLite)
      run: |
        echo "APP_NAME=ribo" > .env
        echo "APP_ENV=local" >> .env
        echo "APP_KEY=dummydummykeydummykey" >> .env
        echo "APP_DEBUG=true" >> .env
        echo "APP_URL=http://localhost" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        echo "DB_DATABASE=/tmp/database.sqlite" >> .env
        touch /tmp/database.sqlite

    # Step 6: Create Laravel cache directories to avoid "valid cache path" errors
    - name: Create Laravel cache directories
      run: |
        mkdir -p bootstrap/cache
        mkdir -p storage/framework/cache
        mkdir -p storage/framework/views
        mkdir -p storage/framework/sessions
        mkdir -p storage/logs
        chmod -R 777 bootstrap/cache storage

    # Step 7: Install Composer manually and run install
    - name: Install Composer dependencies
      run: |
        cd repo  # Navigate to the 'repo' directory
        mkdir -p $HOME/bin
        EXPECTED_SIGNATURE=$(curl -s https://composer.github.io/installer.sig)
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        ACTUAL_SIGNATURE=$(php -r "echo hash_file('sha384', 'composer-setup.php');")
        if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
          >&2 echo 'ERROR: Invalid installer signature'
          exit 1;
        fi
        php composer-setup.php --install-dir=$HOME/bin --filename=composer
        php -r "unlink('composer-setup.php');"
        export PATH="$HOME/bin:$PATH"
        composer install --no-dev --optimize-autoloader  # Run Composer inside the 'repo' directory

      # Step 8: Setup SSH (use GitHub secret)
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        printf "%s" "${{ secrets.CPANEL_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H your.cpanel.server.com >> ~/.ssh/known_hosts

    # Step 9: Deploy to cPanel via Rsync
    - name: Deploy to cPanel
      run: |
        rsync -avz --delete \
        -e "ssh -i ~/.ssh/id_ed25519" \
        --exclude='.git' \
        --exclude='.github' \
        --exclude='node_modules' \
        --exclude='.env' \
        --exclude='storage/' \
        --exclude='public/storage' \
        ./ \
        moonshotdigital@66.176.153.160:/home/ribocrm/staging